#+TITLE: Distro Research for Devcontainer
#+DATE: 2026-02-05

* Overview

Currently using Wolfi (glibc-based, security-focused). Pain point: thin package
ecosystem means many dev tools must be wget-installed.

* Package Availability Comparison

Tools we currently wget in Wolfi:
- gh (GitHub CLI)
- gum (Charm TUI toolkit)
- shellcheck
- entr (file watcher)
- just (task runner)
- yadm (dotfile manager)
- golangci-lint

** Void Linux

| Package       | Available | Install Command              |
|---------------|-----------|------------------------------|
| gh            | YES       | xbps-install github-cli      |
| gum           | ?         | needs verification           |
| shellcheck    | YES       | xbps-install shellcheck      |
| entr          | YES       | xbps-install entr            |
| just          | YES       | xbps-install just            |
| yadm          | YES       | xbps-install yadm            |
| golangci-lint | ?         | needs verification           |

Void has both glibc and musl variants. Would need glibc for Playwright.

** Fedora

| Package       | Available | Install Command              |
|---------------|-----------|------------------------------|
| gh            | YES       | dnf install gh               |
| gum           | ?         | possibly via COPR            |
| shellcheck    | YES       | dnf install ShellCheck       |
| entr          | YES       | dnf install entr             |
| just          | ?         | possibly via COPR            |
| yadm          | YES       | dnf copr enable .../yadm     |
| golangci-lint | YES       | dnf install golangci-lint    |

Fedora is glibc, packages are relatively fresh (6-month release cycle).

** Alpine

| Package       | Available | Notes                        |
|---------------|-----------|------------------------------|
| gh            | YES       | apk add github-cli           |
| gum           | YES       | apk add gum                  |
| shellcheck    | YES       | apk add shellcheck           |
| entr          | YES       | apk add entr                 |
| just          | YES       | apk add just                 |
| yadm          | YES       | apk add yadm                 |
| golangci-lint | YES       | apk add golangci-lint        |

Alpine has excellent package coverage BUT uses musl libc.
Playwright and some prebuilt binaries won't work.

** Wolfi (current)

| Package       | Available | Notes                        |
|---------------|-----------|------------------------------|
| gh            | NO        | wget from GitHub             |
| gum           | NO        | wget from GitHub             |
| shellcheck    | NO        | wget from GitHub             |
| entr          | NO        | wget + compile               |
| just          | YES       | apk add just                 |
| yadm          | NO        | wget from GitHub             |
| golangci-lint | NO        | curl installer               |

Wolfi is glibc (good for Playwright) but thin dev tool coverage.

* Distro Comparison Matrix

| Distro | Size    | libc  | Freshness   | Dev Tools | Container-friendly |
|--------|---------|-------|-------------|-----------|-------------------|
| Wolfi  | ~50MB   | glibc | Fresh       | Poor      | Excellent         |
| Alpine | ~5MB    | musl  | Fresh       | Excellent | Excellent         |
| Fedora | ~170MB  | glibc | Fresh       | Excellent | Good              |
| Void   | ~50MB   | both  | Fresh       | Good      | Good              |
| Debian | ~120MB  | glibc | Stale       | Excellent | Good              |
| Arch   | ~150MB  | glibc | Bleeding    | Excellent | Fair              |
| Ubuntu | ~75MB   | glibc | Mixed       | Excellent | Good              |

* Recommendations

** UPDATED (2026-02-05): Alpine is now viable for browser automation

With ~browser-check.js~, Alpine can do everything we need:
- Playwright API works with system Chromium
- ARIA snapshots with refs (93% context reduction)
- Console/error capture for autonomous debugging
- Screenshots and PDFs

*DONE: Switched to Alpine (2026-02-05)*
- ~Containerfile~ is now Alpine edge (Emacs 30.2, Go 1.25, etc.)
- ~Containerfile.wolfi~ kept as glibc backup
- All dev tools via apk (gh, gum, shellcheck, entr, just, yadm, golangci-lint)
- Browser automation works via browser-check

** Legacy recommendations (before browser-check)

*** If Playwright is required (needs glibc):
1. Fedora - best package coverage, reasonable size
2. Void (glibc) - smaller, good coverage, less mainstream
3. Stay with Wolfi - accept wget maintenance burden

*** If Playwright is NOT required:
1. Alpine - tiny, excellent packages, battle-tested for containers

* Alpine + Playwright Research

** The Problem

Playwright bundles pre-compiled binaries (Node, Chromium) built against glibc.
Alpine uses musl libc, which is NOT binary-compatible with glibc.

Official Playwright stance: "Alpine Linux and other distributions based on musl
standard library are not supported."

** Workarounds Investigated

*** 1. gcompat / libc6-compat layer
- Alpine provides ~libc6-compat~ package
- Works for simple binaries, NOT reliable for complex apps like Chromium
- Chromium has deep glibc dependencies throughout
- Verdict: *Does not work for Playwright*

*** 2. Remote Browser Server (Official workaround)
- Run Playwright client on Alpine
- Connect to Playwright server running in glibc container (mcr.microsoft.com/playwright)
- Command: ~npx playwright run-server~
- Verdict: *Works but adds complexity* (two containers, network overhead)

*** 3. Rebuild Playwright against musl (Hacky)
- Clone playwright-python, rebuild with Alpine's Node
- Replace bundled glibc Node binary with system musl Node
- Symlink system Node into driver directory
- Verdict: *Works but fragile* - author says "don't recommend anyone actually does this"
- Risk: breaks if Playwright adds native glibc module dependencies

*** 4. Zenika/alpine-chrome Docker image
- Community Alpine image with Chromium
- Can work with Playwright
- Verdict: *Partial solution* - maintained by third party

*** 5. System Chromium + PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD (Promising!)
Source: https://github.com/pestphp/pest/issues/1563 (Jan 2026 comment)

Skip Playwright's bundled glibc browser, use Alpine's native musl Chromium:

#+begin_src dockerfile
# Skip bundled browser download
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# Install Alpine's musl-compiled Chromium
RUN apk add --no-cache chromium
#+end_src

#+begin_src javascript
// Point Playwright to system Chromium
const browser = await playwright.chromium.launch({
  executablePath: '/usr/bin/chromium-browser'
});
#+end_src

- Verdict: *NEEDS TESTING* - cleanest approach if it works
- Risk: Playwright version may expect specific Chromium features

** Conclusion

*VERIFIED (2026-02-05):* Alpine + system Chromium + Playwright Node.js API WORKS.

The workaround:
1. ~ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1~
2. ~apk add chromium~
3. Launch with ~executablePath: '/usr/bin/chromium-browser'~

*However:* Higher-level CLI tools do NOT work on Alpine:
- agent-browser: ships glibc binary wrapper
- webctl: Python playwright has no musl wheels

| Tool             | Alpine (musl) | Wolfi (glibc) | Notes                    |
|------------------|---------------|---------------|--------------------------|
| Playwright API   | ✓             | ✓             | Use executablePath       |
| browser-check    | ✓             | ✓             | Our tool, ARIA + refs    |
| npx playwright   | ✗             | ✓             | Ignores system Chromium  |
| agent-browser    | ✗             | ✓             | Hardcodes bundled browser|
| webctl           | ✗             | ✓             | Python wheels need glibc |

Note: ~npx playwright screenshot/pdf~ CLI ignores PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH.
Only the Node.js API (~chromium.launch({executablePath})~) works with system Chromium.

*Decision point:*
- If you only need Playwright API (screenshots, PDFs, console capture): Alpine viable
- If you need agent-browser/webctl CLIs: Stay with Wolfi (or Fedora)

** browser-check: Alpine-compatible agent-browser alternative

We built ~browser-check.js~ as a drop-in replacement that works on Alpine:

#+begin_src shell
# Like agent-browser snapshot -i
browser-check https://localhost:4000 --aria --interactive

# Full diagnostic with JSON (for LLM consumption)
browser-check https://localhost:4000 --aria --interactive --errors --console --json

# Screenshots and PDFs
browser-check https://localhost:4000 --screenshot --pdf
#+end_src

Features:
- ARIA snapshots with refs ([ref=e1], [ref=e2]) like agent-browser
- Console log capture
- Page error detection (JS exceptions)
- Screenshots and PDFs
- JSON output for LLM parsing
- Works on musl (Alpine) with system Chromium

See ~browser-check.js~ in project root.

*** Context reduction verified (blog.thomasbergheim.com)

| Format              | Bytes    | Reduction |
|---------------------|----------|-----------|
| Raw HTML            |    21802 | baseline  |
| Full ARIA snapshot  |     8207 |  62%      |
| Interactive-only    |     1445 |  93%      |

Matches agent-browser's claimed 93% reduction. The hierarchy in browser-check
output may actually be more useful than agent-browser's flat format for
understanding page structure.

** Alternatives to Playwright (if we abandon it)

| Tool              | Pros                          | Cons                         |
|-------------------|-------------------------------|------------------------------|
| Puppeteer         | Similar API                   | Same glibc bundling problem  |
| Selenium          | Uses system browser           | Verbose API, heavyweight     |
| CDP direct        | No bundling issues            | Low-level, more code         |
| agent-browser     | Already in container          | Need to check internals      |
| browserless.io    | No local browser              | External dependency, cost    |
| Playwright Connect| Official solution             | Two containers needed        |

* TODO [7/11]
- [ ] Verify gum availability in Void/Fedora
- [ ] Verify golangci-lint in Void
- [ ] Test Void glibc container image size
- [ ] Test Fedora minimal container image size
- [X] Check if Alpine + glibc-compat works for Playwright → NO
- [X] Test Alpine + system Chromium + PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD
  - [X] Build Alpine test container
  - [X] Install chromium via apk
  - [X] Run playwright with executablePath
  - [X] Verify screenshots/PDF generation work
  RESULT: Playwright Node.js API works (2026-02-05)
  - Navigation, screenshots, PDFs, console capture, error detection all work
  - See browser-check.js for implementation
- [X] Check what agent-browser uses under the hood
  RESULT: Ships glibc Rust binary wrapper - doesn't work on Alpine
  Architecture: Rust CLI (~800KB) + Node.js daemon (Playwright)
  The daemon is pure JS - only the CLI needs rebuild for musl
  Options: gcompat, rebuild with muslrust, pure Node wrapper, upstream PR
- [X] Check webctl
  RESULT: Python playwright has no musl wheels - doesn't work on Alpine
- [X] Build browser-check as Alpine-compatible alternative
  RESULT: Works! ARIA snapshots with refs, 93% context reduction verified
- [X] Verify context reduction matches agent-browser claims
  RESULT: 93% reduction confirmed on real-world page (blog.thomasbergheim.com)

* Backlog

** TODO Unified worktree model
Instead of one container per worktree, mount all worktrees under /workspaces/:

#+begin_example
/workspaces/
  emacs-container/              # main
  emacs-container-alpine-test/  # worktree
  emacs-container-feat-x/       # worktree
#+end_example

Current pain points:
- Each worktree = new container = new terminal window
- Can't ~cd~ to other worktrees from inside container (not mounted)
- Can't easily compare code across branches
- Resource heavy (multiple containers)

Benefits of unified model:
- One container, one tmux session
- Multiple panes for different worktrees
- Just ~cd~ to switch context
- Multiple Claude instances in different panes
- Less resource usage
- Can diff/compare across worktrees

Project deps (.venv, node_modules) are per-directory anyway.

** TODO Add generation date to AGENTS.md template
When scaffolding a project, AGENTS.md should include the date it was generated.

* Sources
- https://voidlinux.org/packages/
- https://packages.fedoraproject.org/
- https://pkgs.alpinelinux.org/
- https://yadm.io/docs/install
- https://github.com/cli/cli/blob/trunk/docs/install_linux.md
