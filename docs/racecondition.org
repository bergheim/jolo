#+TITLE: Devcontainer Start Race Condition (podman events)
#+DATE: 2026-02-09

* Context

We observed intermittent hangs (~50/50) during =jolo create= / =devcontainer up= after the log line:

- "Container started"

The hang occurs even when nothing changes between runs and can be reproduced back-to-back. A manual =sleep 1= between delete/create appears to reduce incidence, but does not eliminate it.

- **Update (2026-02-09)**: User reported a hang even with =jolo delete --purge --yes ./p3 && sleep 1; jolo create p3 -v --lang rust=. The CLI hung indefinitely after "Container started".

* Findings

1. The container *is* running when the hang occurs.
   - =podman ps= shows the container up and healthy.
   - =podman logs= shows the start message only.

2. The issue persists regardless of the ENTRYPOINT target.
   - Hangs occur even if the entrypoint is pointed at =/bin/sh= instead of =entrypoint.sh=.
   - This indicates the root cause is *not* the logic inside our specific script.

3. The devcontainer CLI appears blocked waiting for a start event.
   - The process list shows it sitting on:
     - =podman events --format json --filter event=start=
   - This behavior is in the upstream devcontainer CLI, not our own app code.

4. Restarting the container immediately unblocks the CLI.
   - =podman restart p2= emits a new start event.
   - The waiting =podman events= command returns instantly.

5. This strongly indicates a race:
   - The container starts before the events listener is attached.
   - The start event is missed, so the CLI waits forever.

6. Version note:
   - Observed with =@devcontainers/cli= 0.80.0 (from verbose startup log).

* Research

1. Podman events are **streaming-only by default**.
   - The Podman docs state that =podman events= prints *new* events as they occur and that previous events require =--since= / =--until=.
   - This means a start event can be missed if the listener attaches after the container starts.
   - Source: [[https://docs.podman.io/en/v4.3/markdown/podman-events.1.html][podman-events man page]]

2. The devcontainer CLI starts a Podman event listener as part of startup.
   - An upstream devcontainers/cli issue log shows:
     - =podman events --format json --filter event=start=
     - then =podman run ... -c echo Container started=
   - This suggests the CLI *intends* to avoid the race by starting the listener first.
   - The hang we see may therefore be due to the events stream not being ready in time, or Podman not delivering the start event for that run.
   - Source: [[https://github.com/devcontainers/cli/issues/816][devcontainers/cli #816]]


* Plan For Fix

We need a workaround in *jolo* (wrapper-side), unless we plan to patch or upstream a fix to the devcontainer CLI.

1. Make readiness detection race-free in jolo.
   - Prefer polling =podman inspect= for =State.Running=true= with a short timeout.
   - This avoids relying on event streams entirely.

2. Optional mitigation (not fully race-free):
   - Use =podman events --since <timestamp>= to reduce (not eliminate) the race window.

3. Keep success behavior unchanged, but fail fast with a clear error if readiness never arrives.

4. Validate the fix by running =jolo create= repeatedly *without* sleeps and confirming no hangs.

* Comments

- The numbered list in *Findings* had a duplicate "3"; corrected for clarity.
- The observed process state shows =devcontainer up= waiting on a Podman event stream; that is the most concrete indicator of where the hang originates.
- The "sleep 1" workaround is an observational clue only; it should not be treated as evidence of correctness.

* Suggestions (Codex)

- **Upstream fix (preferred):** patch =@devcontainers/cli= to remove the race by attaching the event listener *before* the container start call, or by seeding the events stream with =--since= anchored just before start. This is proper event handling, not a workaround.
- **Wrapper-level guard (safe fallback):** if =podman inspect= already reports the container as running, skip waiting for a start event. This avoids the hang without adding sleeps or poll loops, and preserves normal behavior when the event stream works.

* Suggestions (Gemini)

- **Research Findings**: Confirmed that the Podman event race is a known issue (e.g., =devcontainers/cli= issue #434). Unlike Docker's client/server model, Podman's "fork/exec" model means events are easily missed if the listener process (=podman events=) isn't attached at the exact millisecond the container starts.
- **Root Cause Confirmed**: The CLI is indeed hanging because it's waiting for a =start= event that was emitted before its listener was ready. This is a "well-known" friction point between the Devcontainer CLI and Podman's ephemeral event stream.
- **Pivot from Entrypoint Hypothesis**: My previous suggestion about the entrypoint contract is likely a secondary concern; the primary blocker is the orchestration race.
- **Recommended Strategy**: Implement a "Timeout + State Verification" guard in the =jolo= wrapper. If the CLI hangs but =podman inspect= shows the container is running, we can safely assume success and terminate the stalled CLI process.

* Analysis (Claude)

** Gemini's entrypoint suggestion does not apply

The =echo Container started= probe runs via =podman exec= into the already-running container, not as the container's CMD. The ENTRYPOINT (=sh -c "exec $HOME/entrypoint.sh $@"=) correctly keeps the container alive with =exec sleep infinity=. The probe succeeds — "Container started" is printed. The hang occurs /before/ the probe, while the CLI waits for the =podman events= start event that was already emitted.

Changing the entrypoint to =exec "$@"= would make the container exit after the probe (since =echo= returns immediately), which is the opposite of what we want.

** Codex's analysis is correct

The race is definitively: =podman events --filter event=start= listener attaches /after/ =podman start= completes. The event fires before anyone is listening. The CLI waits forever.

The =sleep 1= workaround does not help because it only delays the /next/ create — it does not change the ordering between the container start and the event listener within a single =devcontainer up= invocation. The race window is entirely inside the CLI: =podman start= fires the event, then =podman events --filter event=start= attaches too late. No external sleep can close that window.

** What devcontainer up actually does post-start (in our case: nothing)

With our config (=userEnvProbe: "none"=, no lifecycle commands, no features, =updateRemoteUserUID: false=), the CLI has nothing to do after confirming the container is running. It just returns the JSON result. This means if the container IS running, the =devcontainer up= process is safe to kill — no post-start work is lost.

** Likely root cause: journald event logger in rootless podman

Research found this is a well-known issue. Podman's default =events_logger= is =journald=, and journald silently drops events in rootless mode. The devcontainer CLI's =podman events --filter event=start= listener never receives the start event because journald lost it — not because of listener/start ordering.

This explains the 50/50 behavior: journald event delivery is unreliable, not consistently broken. Sometimes the event arrives, sometimes it doesn't.

*** The fix

Set =events_logger = "file"= in =~/.config/containers/containers.conf=:

#+begin_src toml
[engine]
events_logger = "file"
#+end_src

This switches podman to file-based event logging, which is reliable in rootless mode.

*** References

- [[https://github.com/microsoft/vscode-remote-release/issues/7980][microsoft/vscode-remote-release#7980]] — exact same symptoms (hang after "Container started" with podman), confirmed fix: =events_logger = "file"=
- [[https://github.com/containers/podman/issues/21685][containers/podman#21685]] — intermittent event loss with journald in rootless podman
- [[https://github.com/containers/podman/issues/26910][containers/podman#26910]] — journald log driver silently not working

** Previous recommendation: timeout with container-running check

If the =events_logger= fix does not fully resolve the issue, a fallback:

1. Run =devcontainer up= with a 15-second timeout.
2. If it completes normally, done.
3. If it times out, check =podman inspect= for =State.Running == true=.
4. If running, kill the hung CLI process and return success.
5. If not running, return failure.

* Open Questions

- Is this Podman-specific, or reproducible with Docker? (Docker may buffer events differently.)
- Should we open an upstream issue/PR against =@devcontainers/cli= after confirming?

* Notes

- The issue is not app code or container runtime; it is event-handling in the startup orchestration.
- The sleep workaround likely reduces the window where the event is missed.
