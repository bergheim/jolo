#+TITLE: Plan - Container-Only Worktrees + Per-Worktree Tmux Sessions
#+DATE: 2026-02-09

* Summary
Implement a container-only worktree mode that creates git worktrees inside the running container (no host visibility) and opens a dedicated tmux session per worktree using the existing 5-window layout. Provide a just recipe as the preferred entrypoint, backed by a new =jolo worktree= command. No container restarts or additional containers.

* Scope and Behavior
- Worktrees live only inside the container at =$HOME/.cache/jolo/worktrees/<project>/<name>=.
- No new containers; all operations run via =devcontainer exec= in the main project container.
- No container restarts.
- Per-worktree tmux sessions use the existing 5-window tmuxinator layout.

* User-Facing Interfaces
** New CLI Command
=jolo worktree [name] [--from BRANCH] [--prompt "..."] [--agent {claude|gemini|codex|...}] [--detach] [--shell] [--run CMD]=

Behavior:
- If =name= omitted, generate a random name (same as =jolo tree=).
- Ensure main container is running (no restart).
- Inside the container:
  - Create the worktree if missing:
    - =git -C /workspaces/<project> worktree add -b <name> <target> [<from>]=
  - If it already exists, reuse it.
- Attach to tmux session =wt-<name>= rooted at the worktree.
- =--prompt= writes =.devcontainer/.agent-prompt= and =.agent-name= inside the worktree.
- =--shell= or =--run= executes directly in the worktree (no tmux).
- =--detach= creates session but does not attach.

** Just Recipe
Add a =just tree= recipe:
- =just tree <name>= -> =jolo worktree <name>=
- =just tree= -> random name

Add to:
- This repo's =justfile=
- =get_justfile_content()= so new projects include it

* Implementation Details
** 1) Tmux Layout: Session Name + Worktree Root
File: =container/tmux-layout.sh=
- Read =TMUX_SESSION= from env (default =dev=).
- Keep using =WORKSPACE_FOLDER= as root.
- If session exists, attach; else generate temp tmuxinator config:
  - Set =name: <session>=
  - Inject =root: <WORKSPACE_FOLDER>=
  - Preserve 5-window layout
- Keep prompt-file logic intact.

** 2) Container Exec Helpers with Custom Workdir/Env
File: =_jolo/container.py=
- Extend =_runtime_exec()= to accept:
  - =workdir: str | None=
  - =env: dict[str, str] | None=
- Extend =devcontainer_exec_tmux()= and =devcontainer_exec_command()= to accept optional =workdir= and =env=.
- For worktree sessions, pass:
  - =workdir=<worktree path>=
  - =env={"WORKSPACE_FOLDER": <worktree path>, "TMUX_SESSION": "wt-<name>"}=

** 3) Container-Only Worktree Creation
File: =_jolo/worktree.py=
- Add helper =get_container_worktree_path(project_name, worktree_name)= returning
  =$HOME/.cache/jolo/worktrees/<project>/<name>= (container path).
- Add helper =ensure_container_worktree(...)= that:
  - Runs =git -C /workspaces/<project> worktree add ...= inside container
  - Short-circuits if target exists.

** 4) New Command Path
Files: =_jolo/cli.py=, =_jolo/commands.py=
- Add subcommand =worktree= with options aligned to =tree= (prompt/agent/detach/shell/run/from).
- Implement =run_worktree_mode()=:
  - Validate git root.
  - Resolve name (random if omitted).
  - Ensure main container is running (no restart).
  - Create/reuse container-only worktree via =ensure_container_worktree=.
  - If =--prompt=, write prompt files inside the worktree via =devcontainer exec=.
  - If =--shell= or =--run=, exec directly in worktree.
  - Else attach tmux session named =wt-<name>= rooted at worktree.

** 5) Documentation & TODOs
Files: =TODO.org=, optionally =docs/distro.org=
- Mark "Worktree-in-container quick mode (no host visibility)" as DONE.
- Add short note describing container-only mode and per-worktree tmux sessions.

* Tests
** Unit Tests
- =tests/test_cli.py=:
  - Parse =jolo worktree= with name, =--from=, =--prompt=, =--agent=, =--shell=, =--run=.
- =tests/test_commands.py=:
  - =run_worktree_mode= uses =devcontainer_exec_command= for =git worktree add= with correct args.
  - =run_worktree_mode= uses =devcontainer_exec_tmux= with =WORKSPACE_FOLDER= and =TMUX_SESSION=.
- =tests/test_worktree.py=:
  - =get_container_worktree_path()= returns expected container path.

** Manual Validation
- =jolo up= (start main container)
- =just tree feat-x=:
  - =tmux ls= shows =wt-feat-x=
  - session windows use correct root
  - =git status= works inside worktree
- =just tree= (random name) -> new session
- =just tree feat-x= again -> reuse worktree and session

* Assumptions / Defaults
- Worktrees are container-only under =$HOME/.cache/jolo/worktrees/<project>/<name>=.
- Session name format is =wt-<name>=.
- Worktree layout uses existing 5-window tmuxinator config with =root= injected.
- No host visibility or host cleanup required; worktrees persist until container is removed.
