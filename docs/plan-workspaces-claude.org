#+TITLE: Plan: =wt= -- Lightweight In-Container Worktree Manager
#+DATE: 2026-02-09
#+STARTUP: overview

* Context

Currently =jolo tree= creates worktrees as separate containers -- each with its
own devcontainer.json, port, credentials, Emacs config. This is the right
approach for total isolation but is heavyweight for quick branch work.

This plan adds a lightweight alternative: create git worktrees *inside* the
running container, each with its own tmux session. Switch between them instantly
with =wt <name>= or tmux's =C-b s= session picker.

* Design

A =wt= shell script installed in the container image at =/usr/local/bin/wt=.

** Commands

| Command                                    | Action                           |
|--------------------------------------------+----------------------------------|
| =wt new <name> [--from <ref>] [-p <prompt>]= | Create worktree + tmux session   |
| =wt <name>=                                | Switch to worktree session       |
| =wt main=                                  | Switch back to "dev" session     |
| =wt list=                                  | List worktree sessions           |
| =wt delete <name>=                         | Remove worktree + kill session   |
| =wt= (no args)                             | Same as =wt list=                |

Aliases: =ls= for =list=, =rm= for =delete=.

** Worktree location

Worktrees at =/workspaces/<name>= -- on the container filesystem (outside the
bind-mounted project directory).

- *Committed work is safe* -- git objects live in =.git/= on the bind mount
- *Uncommitted edits are ephemeral* -- lost on container stop
- *Branches persist* -- refs are in =.git/refs/= on the bind mount
- No host-side pollution, no stale paths in =git worktree list= on host
- After container restart: =wt new feat-x --from feat-x= recreates the working tree

=jolo tree= remains available when full container isolation is needed.

** Tmux session naming

Worktree sessions named =wt-<name>= to avoid collision with the main =dev=
session. Users can also switch with tmux's built-in =C-b s= session picker.

** Each session gets the full dev layout

Mirrors =container/dev.yml= -- 5 windows: emacs, claude, gemini, codex, shell.
All windows rooted in the worktree directory via tmuxinator's =root:= directive.

* Implementation

** New file: =container/wt= (~150 lines)

Shell script structure:

#+begin_src sh
#!/bin/sh
set -e

# --- Config ---
WS="${WORKSPACE_FOLDER:-$(pwd)}"
TMUX_CONFIG="$HOME/.config/tmuxinator/dev.yml"
ADJECTIVES="brave swift calm bold keen wild warm cool fair wise"
NOUNS="panda falcon river mountain oak wolf hawk cedar fox bear"

# --- Helpers ---
random_name()        # shuf from embedded word lists
session_name()       # "wt-<name>"
generate_config()    # copy dev.yml to /tmp/, change name + add root
die()                # stderr + exit 1

# --- Subcommands ---
cmd_new "$@"
cmd_switch "$1"
cmd_list
cmd_delete "$@"

# --- Dispatch ---
case "$1" in
    new)        shift; cmd_new "$@" ;;
    ls|list)    cmd_list ;;
    rm|delete)  shift; cmd_delete "$@" ;;
    main)       tmux switch-client -t dev ;;
    "")         cmd_list ;;
    -h|--help)  usage ;;
    *)          cmd_switch "$1" ;;
esac
#+end_src

*** =cmd_new=

1. Validate: must be inside tmux, must have git
2. Generate random name if none given (adjective-noun, matching =_jolo/constants.py=)
3. =git worktree add -b <name> /workspaces/<name> [<from-ref>]=
4. Generate tmuxinator config: copy =dev.yml=, set =name: wt-<name>=, add =root: /workspaces/<name>=
5. If =-p <prompt>=: patch config with same sed logic as =tmux-layout.sh= lines 21-33
6. =tmuxinator start -p /tmp/wt-<name>.yml=
7. =tmux switch-client -t wt-<name>=

*** =cmd_switch=

1. Check session =wt-<name>= exists
2. If yes: =tmux switch-client -t wt-<name>=
3. If no but worktree exists at =/workspaces/<name>=: create session, then switch

*** =cmd_list=

1. =git worktree list= from =$WORKSPACE_FOLDER=
2. Filter to =/workspaces/*= excluding main workspace
3. For each: check if tmux session exists, show branch name
4. Mark current session with =*=

*** =cmd_delete=

1. Check for uncommitted changes (=git status --porcelain=), warn if dirty
2. If currently in this session: switch to =dev= first
3. =tmux kill-session -t wt-<name>=
4. =git worktree remove --force /workspaces/<name>=

** Modify: =Containerfile= (2 lines)

At lines 102-104 (root-level COPY section, before =USER $USERNAME=):

#+begin_src dockerfile
COPY container/wt /usr/local/bin/wt
#+end_src

Update chmod line:

#+begin_src dockerfile
RUN chmod +x /usr/local/bin/e /usr/local/bin/motd /usr/local/bin/wt && \
#+end_src

* Reused patterns

| Pattern                   | Source                          | Usage in =wt=                        |
|---------------------------+---------------------------------+--------------------------------------|
| Tmuxinator config patching | =tmux-layout.sh= lines 28-34   | Copy dev.yml, patch name/root        |
| Prompt mode sed logic     | =tmux-layout.sh= lines 21-33   | Start agent with prompt in window    |
| Word lists                | =_jolo/constants.py= lines 11-34 | Random name generation (same words)  |
| Session reattach =-d=     | =tmux-layout.sh= line 7        | Detach other clients for resizing    |
| Dev layout                | =container/dev.yml=             | Template for worktree sessions       |

* Key files

- =container/wt= -- *new*: the entire =wt= command
- =Containerfile:100-107= -- root-level COPY section (add wt)
- =container/tmux-layout.sh= -- reference: tmuxinator patching pattern
- =container/dev.yml= -- reference: template for worktree session layout
- =_jolo/constants.py:11-34= -- reference: word lists to keep consistent

* Verification

1. Build: =podman build -t emacs-gui .=
2. Start container with jolo or manually
3. Inside container:
   - =wt new test-feat= -- creates worktree + session, switches to it
   - Verify all 5 windows exist, all cd'd to =/workspaces/test-feat=
   - =wt main= -- switches back to dev session
   - =wt list= -- shows test-feat with session status
   - Make a commit in worktree, verify visible from main
   - =wt delete test-feat= -- removes worktree + session
   - =wt new prompted -p "hello world"= -- verify claude starts with prompt
   - =C-b s= -- verify tmux session picker shows both =dev= and =wt-*= sessions
