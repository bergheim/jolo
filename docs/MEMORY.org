#+TITLE: Shared Memory
#+DATE: 2026-02-15

Shared knowledge base for all agents working on this project.
Read on session start. Write discoveries, conventions, and patterns here.
Tag entries with keywords (e.g., =:auth:perf:musl:=) for searchability.

* Conventions

- Org-mode preferred over markdown for project docs                    :docs:
- Pre-commit hooks must pass before committing                         :workflow:
- System Python has no pip; use =uv= for everything                   :python:

* Patterns

- Secrets flow: =get_secrets()= -> =os.environ.update()= -> =${localEnv:...}= in devcontainer.json :jolo:
- =devcontainer_up(remove_existing=True)= tears down old container first — skip port checks :jolo:
- Motd runs in all tmux panes; per-window commands belong in =dev.yml= :tmux:
- Template functions accept =bare=False= kwarg to skip web scaffold    :jolo:templates:
- =.bare= suffix convention for template variants (e.g., =justfile.bare=) :jolo:templates:
- =@elysiajs/static= serves files at =/public/= prefix by default but only works via real server, not =app.handle()= :elysia:bun:
- OpenSpec CLI is image-provided via =pnpm add -g fission-ai/openspec@latest= (intentionally unpinned) :openspec:container:
- Do not force =TERM=tmux-direct= in devcontainer env/shell; let tmux negotiate TERM and enable =terminal-features ...:extkeys= for rich key input :tmux:term-keys:
- Host =~/.tmux.conf= =set -g terminal-features= (non-appending) clobbers =/etc/tmux.conf=; must use =set -as= :tmux:terminal:
- =clipboard= terminal-feature (tmux 3.2+) replaces the old =Ms= terminal-override for OSC 52 :tmux:clipboard:
- Mosh 1.4.0 supports OSC 52 but only with =c;= selection — tmux's =clipboard= feature emits =;;= (empty) which mosh drops :mosh:clipboard:
- For mosh clipboard: remove =clipboard= from =terminal-features=, use =Ms= override with hardcoded =c;=: =set -as terminal-overrides ',*:Ms=\\E]52;c%p1%.0s;%p2%s\\7'= :mosh:clipboard:tmux:

* Terminal Image Display                                       :terminal:images:

- Three protocols: Sixel (1983 DEC), Kitty graphics (2017), iTerm2 inline images
- Kitty protocol is technically superior: 32-bit RGBA, caching, transparency, proper spec
- Sixel: palette-based color, no transparency, no caching, underspecified behavior
- Kitty/Ghostty refuse to implement sixel — push ecosystem toward kitty protocol
- tmux supports sixel natively (buggy: flickering, input-buffer-size limits) but NOT kitty graphics
- Kitty graphics through tmux uses *unicode placeholders* (U+10EEEE) — only kitty and Ghostty support this
- Container uses =kitty-kitten= package (25MB) for =kitten icat= command
- =icat= alias in container points to =kitten icat= (works through tmux with Ghostty/kitty host)
- =chafa= still installed as fallback (auto-detects protocol, falls back to Unicode block art)
- Host terminal must be Ghostty or kitty for images-in-tmux to work via kitty protocol
- WezTerm: supports all 3 protocols but maintenance stalled (last stable release Feb 2024)
- Alacritty: zero image protocol support, maintainers refuse to add it
- foot: Wayland-only (no X11), sixel only — not viable for dual Sway+i3 setup
- Ghostty: GTK4 (Wayland+X11), kitty graphics + unicode placeholders, Arch =extra= repo
- tmux =input-buffer-size= defaults to 1MB — large sixel images silently dropped; increase to 4MB+ if using sixel
- =TERM_PROGRAM= env var does not propagate over SSH — cannot detect host terminal via env vars in containers

* Container Security Assessment (2026-02)                      :security:container:

Researched adding bubblewrap, Landlock, seccomp, nono etc. inside rootless Podman containers.
Conclusion: mostly ceremony for our setup. Details:

- Rootless Podman is already a strong boundary — recent runc escape CVEs (Nov 2025) are explicitly mitigated by rootless containers
- GPG keys: private keys never enter container, only agent socket (RO). Safe.
- SSH keys: not mounted at all. Safe.
- =.gitconfig=, =.zshrc=, =.config/gh=, =.config/tmux=: all mounted RO
- Claude =.credentials.json=: mounted RW (token refresh needs persist to host)
- Gemini/Codex/Pi creds: copied RW into =.devcontainer/= cache dirs
- API keys (=ANTHROPIC_API_KEY=, =OPENAI_API_KEY=, =GH_TOKEN=): env vars, readable by any process
- The "confused deputy" problem: agent NEEDS credentials to function, same credentials can be abused via prompt injection
- Landlock/bwrap inside container = nesting namespace isolation for marginal gain, high breakage risk
- Network filtering breaks legitimate workflows; agent can exfiltrate through allowed channels (git push, API calls)
- Simon Willison's "Lethal Trifecta": private data + untrusted content + external comms = fundamentally vulnerable
- OpenAI admits prompt injection "unlikely to ever be fully solved"
- Real improvements: scoped git tokens, credential rotation, reviewing agent output — not more OS sandbox layers
- Egress monitoring (logging, not blocking) is the one addition that could provide visibility without breakage

* Gotchas

- Grep/Glob tools sometimes miss =_jolo/*.py= — use =**/_jolo/**/*.py= or =ls= :tooling:
- Alpine uses musl; glibc .so/.elc files are not compatible           :musl:
- =gh= auth token is in OS keyring, not =hosts.yml= — need =gh auth token= to extract :gh:
- =templates/.gitignore= has a blanket =public/= ignore (Gatsby) — fixed to =public/*.css= + =public/*.js= instead :jolo:gitignore:
- Codex =exec= ignores piped stdin diff — it runs =git diff= internally and only sees unstaged changes :codex:review:
- Gemini misreads =@= in npm package names as leading spaces in diffs :gemini:review:
