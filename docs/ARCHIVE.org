#+TITLE: Archive — Completed Tasks and Security Analysis
#+DESCRIPTION: Completed work and reference material moved from TODO.org

* Completed Tasks
** DONE Install OpenSpec CLI in container image via pnpm latest
   Added =fission-ai/openspec@latest= to global =pnpm add -g= in =Containerfile=.
** DONE Set default Codex reasoning effort in generated project config
** DONE Add shared per-project multi-agent memory + per-agent personal memory
** DONE Tmux copy/paste broken over mosh (works over ssh)
   Root cause: mosh 1.4.0 only accepts OSC 52 with =c;= selection parameter.
   tmux's =clipboard= terminal-feature emits =;;= (empty selection) which mosh drops.
   Fix: remove =clipboard= from =terminal-features=, use =Ms= override with hardcoded =c;=.
   See =docs/RESEARCH.org= for full details.
** CANCELLED Send agent findings via email (or similar async channel)
   ntfy.sh covers this well enough.
** DONE Auto-copy dev server URL to clipboard on launch
   Implemented differently than originally planned: URL is copied to clipboard
   via OSC 52 on =jolo up= / =jolo create= (not on =just dev=). Writes to
   =/dev/tty= to bypass pipes. Motd shows "(in clipboard)" next to URL.
** DONE Fix =jolo delete= bare name resolution
   =jolo create foo= takes a bare name, but =jolo delete foo= only searches worktree
   names — can't find the project you just created. Simplified: bare names resolve as
   =cwd / name=, worktree deletion via interactive picker only. Also added interactive
   purge prompt and guards against worktree-path and ancestor git root escalation.
** DONE Generated projects should include a stub HTTP service with hot reload (including browser reload)
   Per-project scaffolding target (SOTA defaults):
   - DONE TypeScript: BETH stack (Bun + Elysia + Tailwind + HTMX), =typescript-bare= for plain Bun
   - DONE Python: FastAPI + Uvicorn + Jinja2 + HTMX (=python-web= flavor)
   - DONE Go: stdlib 1.22+ ServeMux + templ + HTMX + Air (=go-web= flavor)
   - DONE Rust: Axum + MiniJinja + HTMX + Tailwind (=rust-web= flavor)
   Shell/other flavors are non-web by design — no HTTP scaffold needed.
** DONE Tighten BETH TypeScript scaffold plan before implementation
   All three blockers resolved in the shipped scaffold.
** DONE Flatten language+variant into single flavor menu
   The =--bare= flag threads a cross-cutting =bare= parameter through 5 function
   signatures and 5 callsites in templates.py. This doesn't scale — adding web
   variants for Python/Go would mean more flags. Instead, flatten language + variant
   into a single "flavor" concept: users pick =TypeScript (web)= or =TypeScript (bare)=
   from one menu, code uses flat string matching (="typescript-web"=, ="typescript-bare"=).

*** Motivation
    - Eliminates =bare= param from 5 functions + 5 callsites
    - Makes variant selection discoverable (visible in the picker, not hidden behind a flag)
    - Scales cleanly: adding "Go (web)" later is just a new menu entry, not a new flag

*** Changes

**** 1. Constants (=_jolo/constants.py=)
     - =VALID_LANGUAGES= → =VALID_FLAVORS=: add =typescript-web=, =typescript-bare=, drop =typescript=
     - =LANGUAGE_OPTIONS= → =FLAVOR_OPTIONS=: replace ="TypeScript"= with ="TypeScript (web)"= and ="TypeScript (bare)"=
     - =LANGUAGE_CODE_MAP= → =FLAVOR_CODE_MAP=
     - Add =BASE_LANGUAGE= mapping: ={"typescript-web": "typescript", "typescript-bare": "typescript"}=
       Flavors without variants map to themselves. Used by pre-commit hook lookup.

**** 2. CLI (=_jolo/cli.py=)
     - Rename selector functions: =select_languages_interactive= → =select_flavors_interactive=
     - Update =parse_lang_arg()= to validate against =VALID_FLAVORS=
     - Remove =--bare= flag from =create= subparser

**** 3. Templates (=_jolo/templates.py=)
     Remove =bare= parameter from all 5 functions, use flat flavor string matching:
     - =get_type_checker_config(flavor)= — match ="typescript-web"= vs ="typescript-bare"=
     - =get_justfile_content(flavor, project_name)= — pick template by flavor
     - =get_test_framework_config(flavor)= — pick test file by flavor
     - =get_scaffold_files(flavor)= — BETH files for ="typescript-web"=, empty otherwise
     - =get_project_init_commands(flavor, project_name)= — match on full flavor
     For pre-commit: =generate_precommit_config()= uses =BASE_LANGUAGE= mapping for hook lookup.

**** 4. Commands (=_jolo/commands.py=)
     - =run_create_mode()=: drop =bare = getattr(args, "bare", False)=
     - Remove all =bare=bare= kwargs, pass flavor string directly

**** 5. Exports (=_jolo/__init__.py=) and tests
     - Update renamed exports
     - Update tests from =bare=True= → flavor strings
     - Replace =VALID_LANGUAGES= refs with =VALID_FLAVORS=

*** Files affected
    | File                    | Change                                                 |
    |-------------------------+--------------------------------------------------------|
    | =_jolo/constants.py=    | Rename constants, add =BASE_LANGUAGE=, split TS flavors |
    | =_jolo/cli.py=          | Rename selectors, remove =--bare=, validate flavors     |
    | =_jolo/templates.py=    | Remove =bare= param from 5 functions, flat matching     |
    | =_jolo/commands.py=     | Remove =bare= variable, pass flavor strings             |
    | =_jolo/__init__.py=     | Update exports                                          |
    | =tests/test_templates.py= | Update to flavor strings                              |
    | =tests/test_cli.py=     | Update selector + parse tests                           |

*** Verification
    - =just test= — all tests pass
    - =rg 'bare' _jolo/= — no remaining =bare= refs in production code
    - =jolo create testproj --lang typescript-web= works (BETH scaffold)
    - =jolo create testproj --lang typescript-bare= works (minimal TS)
    - =jolo create testproj= shows flattened menu with both TS options
** DONE Fix mixed-language pre-commit generation dropping prose hooks
   Root cause: prose hooks were skipped unless =languages == ["prose"]=.
   Fix: removed the guard in =_jolo/templates.py= so prose hooks are included
   whenever =prose= is selected.
** DONE Consider adding `jolo exec` command to align with container conventions
** DONE Add =host-ops= skill for manual host-side work (outside container)
   New skill at =templates/.agents/skills/host-ops/SKILL.md=.
   Standardizes machine labels:
   - =tux= (laptop/client)
   - =berghome= (home/server)
   and requires step-by-step manual playbooks with verify + rollback.
** DONE Rebuild container image to pick up notify fixes
** DONE Format ntfy elapsed time as human-readable (e.g. 7m 2s, 1h 15m)
   Added =format_elapsed()= to =container/notify=. Under 1m: =30s=,
   under 1h: =6m 55s=, 1h+: =1h 15m=. Shell test suite in =tests/test_notify.sh=.
** DONE Add notification slow-threshold config (default 60s) with local override to 20s
   =.jolo.toml= with =notify_threshold = 20= overrides the 60s default.
   Config flows through =load_config()= -> =setup_notification_hooks()= -> Claude =--if-slow= hook.
** DONE Review /afk branches (5 local, unmerged)
   Cherry-picked 4 of 5 to main (19 new tests + shellcheck fixes).
   Deleted =yolo/export-remove-image= (dead export, nothing uses it).
** DONE Add =--deep= flag to =jolo research=
   Implemented in =run_research_mode()= + =_run_research_deep()=:
   claude and codex run in parallel, then gemini writes synthesis.
** DONE Redesign =jolo research= — standalone research repo, no worktrees
   :PROPERTIES:
   :BRANCH: feat/jolo-research
   :END:

   Current implementation requires being in a git repo and uses worktrees.
   Redesign: fixed research repo at =~/jolo/research/=, persistent container,
   fire-and-forget agent exec. Works from anywhere.

*** Flow
    #+begin_example
    jolo research "what is an apple"
    #+end_example

    1. =ensure_research_repo(config)= — create =~/jolo/research/= if needed
    2. Start container if not running (=devcontainer up=, idempotent)
    3. Pick agent (=--agent= override or round-robin), generate filename =YYYY-MM-DD-slug.org=
    4. =devcontainer exec= agent in background: =agent -p "/research ..."=
    5. Agent writes file (prompt at top), commits to main, ntfy fires via hook
    6. Print confirmation, return immediately

*** Outcome
    Implemented via =ensure_research_repo()= and persistent
    =~/jolo/research= container flow in =run_research_mode()=.

*** Files to change
    | File                                  | What                                                          |
    |---------------------------------------+---------------------------------------------------------------|
    | =_jolo/constants.py=                  | Add ="research_home": "~/jolo/research"= to DEFAULT_CONFIG    |
    | =_jolo/cli.py=                        | Add =slugify_prompt()=                                        |
    | =_jolo/commands.py=                   | Add =ensure_research_repo()=, rewrite =run_research_mode()=,  |
    |                                       | delete =_spawn_research_watcher()=                            |
    | =_jolo/__init__.py=                   | Update exports                                                |
    | =container/tmux-layout.sh=            | Delete research mode block                                    |
    | =templates/.agents/skills/research/=  | Per-file output support, prompt in file                       |
    | =tests/test_research.py=              | Rewrite for new behavior                                      |

*** =ensure_research_repo(config)=
    - Expand =~/jolo/research/=, return path if =.git= exists
    - =mkdir -p=, =git init=, =scaffold_devcontainer("research", ...)=
    - Copy just the research skill (=.agents/skills/research/=), not full template
    - Initial commit
    - Minimal repo: just org files, devcontainer config, and the research skill

*** =run_research_mode(args)= (rewrite)
    - No =validate_tree_mode()= — call =ensure_research_repo(config)= instead
    - =slugify_prompt(args.prompt)= → filename =YYYY-MM-DD-slug.org=
    - Setup credentials/hooks on the research repo (idempotent)
    - =is_container_running(research_home)=? If not, =devcontainer_up=
    - =devcontainer_exec_command= with backgrounded agent: =nohup agent -p "..." &=
    - Prompt tells agent: write to specific file, include original question

*** Research skill update (=SKILL.md=)
    - If prompt specifies a target filename, write to that file (not =RESEARCH.org=)
    - Standalone file with =#+TITLE:=, =#+PROPERTY: PROMPT=
    - Remove multi-agent append-only language (each file is standalone)

*** Verification
    #+begin_example
    cd /tmp && jolo research "what is an apple"
    # → Research started: claude → 2026-02-11-what-is-an-apple.org
    # Check ~/jolo/research/ for the org file after agent finishes
    #+end_example
** DONE =wt new= should only create 1 tmux window (shell), not the full 5-window layout
   Worktrees are lightweight throwaway branches. Spawning emacs + claude + gemini + codex
   windows per worktree floods the tmux window list. Just a shell is enough.
** DONE Decide whether to add a "safe worktree" default for initial jolo setup (keep main repo untouched)
   Decision: no. =jolo tree= already works standalone from any git repo
   without needing =jolo up= first. Agents follow branch workflow via AGENTS.md.
** DONE Add a shared mounted space between all devcontainers for global resources
   Default mount: ~/stash -> /workspaces/stash (RW, non-reproducible).
** DONE Fix term-keys breakage from forced TERM in devcontainer
   Removed forced =TERM=tmux-direct= from generated container env and shell init.
   Added tmux =extkeys= terminal-features hints for =tmux-direct=, =xterm-256color=, and =wezterm=.
   Follow-up (external review): switched tmux config to =set -as terminal-features=
   and added =kitty/alacritty/foot= extkeys hints to avoid clobbering defaults.
** DONE Fix host ~/.tmux.conf terminal-features clobbering
   Host config now uses =set -as= (appending). Consolidated clipboard/sixel/extkeys.
   Container =/etc/tmux.conf= also uses =set -as= so both coexist.
   Additionally: removed =clipboard= from host terminal-features to enable =Ms= override
   for mosh OSC 52 compatibility.
** DONE Add doc-compare skill for narrative version diffs
** DONE Add doc-critique skill for writing feedback
** DONE Alternate agents between external reviews in feature-workflow
** DONE Draft end-user README for Codex (docs/README-codex.org)
** DONE Plan: add `jolo clone <git-url> [dir]` command (devcontainer wrapper)
   - Goal: `jolo clone` clones a repo and immediately brings it up in a devcontainer.
   - Signature: `jolo clone <url> [dir]`
   - Default clone location: `repos/<name>` at workspace root.
   - AGENTS/CLAUDE handling: keep foreign agent files; add top-level guidance in this repo's AGENTS that cloned repo instructions apply only within that folder.
   - Behavior: should automatically run `jolo up` for the cloned repo after clone.
   - Notes: Beads is installed but cannot be initialized in this worktree.
     - Error: `bd init` fails in worktree; must init in main repo.
     - Required flow:
       1) `cd /workspaces/emacs-container`
       2) `bd init`
       3) `bd worktree create <path> --branch <branch-name>`
     - Reference: https://github.com/steveyegge/beads/blob/main/docs/WORKTREES.md
** DONE Smart MOTD on every new shell session
** DONE Prefix container names with project name
** DONE Rename =jolo switch= to =jolo open=
** DONE Add interactive project switcher to jolo
** DONE Agent Skills open standard with =.agents/skills/=
** DONE Unified =jolo delete= — worktree and project removal
** DONE Tmux session layout — auto-start emacs + AI agents (tmuxinator-style)
** DONE Add a justfile for the jolo meta-project
** DONE Coding style conventions for AI agents
** DONE Tmux copy to host clipboard does not work
** DONE Add template metadata placeholders
** DONE Add podman image/storage cleanup to =jolo prune=
** DONE Mount ~/.claude RW instead of copying credentials
** DONE Worktree-in-container quick mode (=wt= command)
** DONE Speed up Emacs config staging                     :emacs:perf:
** DONE Pre-install zimfw in Containerfile                  :zsh:perf:
** DONE Run motd only in the shell window                   :tmux:perf:
** DONE Enable sixel image display in terminal             :terminal:graphics:
** DONE Add review skill for cross-agent checks            :skills:
** DONE Add research skill for agented web notes           :skills:
** DONE Add big-task workflow skill                        :skills:
** DONE Activate ruff linting and fix all violations        :code-quality:
** DONE Rework GitHub Actions CI workflow                     :ci:github:
** DONE Add terminal bell to notify-done                       :notifications:
** DONE Tighten comment policy in AGENTS.md                    :docs:style:
** DONE =jolo up --new --sync= fails when port already in use :jolo:bug:
** DONE Agent completion notifications via ntfy.sh          :agents:notifications:
** DONE Emacs config isolation improvements
** DONE Add --mount and --copy options to jolo.py
** DONE Delete start-emacs.sh (redundant — jolo handles Wayland + Emacs config)

* Security Analysis for Autonomous Agent Execution

Practical security assessment — what actually matters vs security theater.

Guiding principle: If removing access breaks the tool's usefulness, it's not a security improvement - it's just making the tool worse.

** SAFE: GPG Agent Socket
Only the agent socket is mounted, not the private keys.
Private keys *never enter the container*. Agent can request signatures but cannot extract key material.

** FIXED: Claude Configuration (~/.claude)
Selective mounts (readonly): =.credentials.json=, =settings.json=, =statsig/=.
Excluded: =projects/=, =history.jsonl=, =todos/=.

** INHERENT: API Keys in Environment
No key = no Claude. Required for tool to function.

** INHERENT: GitHub CLI Configuration
Readonly mount. You want =gh= commands to work.

** INHERENT: Network Access
Full network access, ports 4000-5000 forwarded. Required for everything.

** SAFE: Git Configuration
Readonly. Needed for git to work.

** INHERENT: Workspace Access
Full read/write to project directory. This IS the point.

** SAFE: Sudo with Known Password
With rootless Podman: root inside container ≠ root on host.

** DONE: Shell History
=.histfile= persisted in =.devcontainer/= (per-project, gitignored).

** FIXED: Emacs Configuration
=jolo.py= copies config to =.devcontainer/.emacs-config/= (writable, isolated).

** Summary
| Resource          | Status   | Reason                                    |
|-------------------+----------+-------------------------------------------|
| GPG Socket        | SAFE     | Private keys never exposed                |
| ~/.claude         | FIXED    | Selective readonly (no projects/history)  |
| API Keys          | INHERENT | Required to use the service               |
| GitHub CLI        | INHERENT | You want gh commands to work              |
| Network           | INHERENT | Required for everything                   |
| Git Config        | SAFE     | Already readonly                          |
| Workspace         | INHERENT | This is the entire point                  |
| Sudo              | SAFE     | Rootless container, not a host risk       |
| Shell History     | DONE     | Per-project in .devcontainer/             |
| Emacs Config      | FIXED    | Config and cache both readonly            |

** What Would Actually Be Dangerous (that we're NOT doing)
- Mounting =~/.ssh= (private keys)
- Mounting =~/.gnupg/private-keys-v1.d=
- Mounting =~/.password-store=
- Running as root with =--privileged=
- Mounting host root filesystem
