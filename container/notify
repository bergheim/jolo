#!/bin/sh
# notify — Send push notification when an AI agent finishes.
# Called by agent session-end hooks. Receives JSON context on stdin.
#
# Usage:
#   notify              — always send notification (original behavior)
#   notify stamp        — record current time to $HOME/.notify-prompt-start
#   notify --if-slow S  — notify only if >S seconds since stamp
#
# Environment:
#   NTFY_SERVER  — ntfy server URL (default: https://ntfy.sh)
#   NTFY_TOPIC   — notification topic (default: jolo)
#   PROJECT      — project name (default: unknown)
#   AGENT        — agent name (default: unknown)

set -e

STAMP_FILE="$HOME/.notify-prompt-start"

# --- stamp mode: record current time and exit ---
if [ "${1:-}" = "stamp" ]; then
    date +%s > "$STAMP_FILE"
    exit 0
fi

# --- --if-slow mode: check elapsed time, notify only if slow ---
if [ "${1:-}" = "--if-slow" ]; then
    THRESHOLD="${2:?Usage: notify --if-slow SECONDS}"

    # Silently exit if no stamp file
    [ -f "$STAMP_FILE" ] || exit 0

    START=$(cat "$STAMP_FILE")
    rm -f "$STAMP_FILE"
    NOW=$(date +%s)
    ELAPSED=$((NOW - START))

    # Exit silently if under threshold
    [ "$ELAPSED" -gt "$THRESHOLD" ] || exit 0

    # Fall through to send notification with elapsed info
    ELAPSED_INFO=" (${ELAPSED}s)"
fi

# If no --if-slow, still include elapsed time when available
if [ -z "${ELAPSED_INFO:-}" ] && [ -f "$STAMP_FILE" ]; then
    START=$(cat "$STAMP_FILE")
    rm -f "$STAMP_FILE"
    NOW=$(date +%s)
    ELAPSED=$((NOW - START))
    ELAPSED_INFO=" (${ELAPSED}s)"
fi

SERVER="${NTFY_SERVER:-https://ntfy.sh}"
TOPIC="${NTFY_TOPIC:-jolo}"
PROJECT="${PROJECT:-unknown}"
AGENT="${AGENT:-unknown}"

# Drain stdin (agents pipe JSON context) — skip if interactive terminal
CONTEXT=""
if [ ! -t 0 ]; then
    CONTEXT=$(cat 2>/dev/null || true)
fi

TITLE="${PROJECT} - ${AGENT} finished"
BODY=""

LAST_COMMIT=""
if command -v git >/dev/null 2>&1; then
    LAST_COMMIT=$(git -C "${WORKSPACE:-$PWD}" log -1 --pretty=%s 2>/dev/null || true)
fi
[ -n "$LAST_COMMIT" ] && BODY="${LAST_COMMIT}${ELAPSED_INFO:-}"

COMMIT_URL=""
if command -v git >/dev/null 2>&1; then
    REPO_URL=$(git -C "${WORKSPACE:-$PWD}" remote get-url origin 2>/dev/null || true)
    SHA=$(git -C "${WORKSPACE:-$PWD}" rev-parse HEAD 2>/dev/null || true)
    if [ -n "$REPO_URL" ] && [ -n "$SHA" ]; then
        REPO_URL=${REPO_URL%.git}
        case "$REPO_URL" in
            git@github.com:*)
                REPO_URL="https://github.com/${REPO_URL#git@github.com:}"
                ;;
        esac
        case "$REPO_URL" in
            https://github.com/*)
                COMMIT_URL="${REPO_URL}/commit/${SHA}"
                ;;
        esac
    fi
fi
CLICK_HEADER=""
ACTIONS_HEADER=""
if [ -n "$COMMIT_URL" ]; then
    CLICK_HEADER="Click: ${COMMIT_URL}"
    ACTIONS_HEADER="Actions: view, Open commit, ${COMMIT_URL}"
fi

# Fire and forget — don't let notification failure affect the agent
curl -sf --max-time 5 \
    -H "Title: ${TITLE}" \
    -H "Priority: default" \
    -H "Tags: robot,checkmark" \
    ${CLICK_HEADER:+-H "$CLICK_HEADER"} \
    ${ACTIONS_HEADER:+-H "$ACTIONS_HEADER"} \
    -d "${BODY}" \
    "${SERVER}/${TOPIC}" \
    >/dev/null 2>&1 || true

# Terminal bell — sets URGENT flag on host window
printf '\a'
