#!/bin/sh
# Smart MOTD - context-aware welcome for container shells

# Project name from git remote or directory basename
project=$(git remote get-url origin 2>/dev/null | sed 's|.*/||;s|\.git$||')
[ -z "$project" ] && project=$(basename "$PWD")

# Git info
branch=$(git symbolic-ref --short HEAD 2>/dev/null)
if [ -n "$branch" ]; then
    dirty=$(git diff --quiet HEAD 2>/dev/null || echo " *")
    recent=$(git log -3 --format='%ar|%s' 2>/dev/null | sed 's/ seconds\{0,1\} ago/s/;s/ minutes\{0,1\} ago/m/;s/ hours\{0,1\} ago/h/;s/ days\{0,1\} ago/d/;s/ weeks\{0,1\} ago/w/;s/ months\{0,1\} ago/mo/;s/ years\{0,1\} ago/y/;s/|/ /' | cut -c1-60)
    git_line=$(printf '%s\n%s' "$branch$dirty" "$recent")
fi

# Build header with full URL
header="$project"
if [ -n "$DEV_HOST" ] && [ -n "$PORT" ]; then
    header="$header  http://${DEV_HOST}:${PORT}"
elif [ -n "$PORT" ]; then
    header="$header  :$PORT"
fi

# Hint line
hint=""
if [ -f justfile ] || [ -f Justfile ]; then
    hint="Run tasks with: just <recipe>"
fi
stash="Stash: /workspaces/stash (non-reproducible)"

# Print bordered header
gum style --border rounded --padding "0 1" --border-foreground 4 "$header" ${git_line:+"$git_line"} ${hint:+"$hint"} ${stash:+"$stash"}

# Show justfile targets, static MOTD, or fallback
if [ -f justfile ] || [ -f Justfile ]; then
    echo ""
    just --list --unsorted 2>/dev/null
elif [ -f MOTD ]; then
    echo ""
    cat MOTD
else
    echo ""
    echo "  browser-check URL --describe    Inspect a page"
    echo "  pre-commit run --all-files      Run linters"
    echo "  just                            Run tasks (add a justfile)"
fi
